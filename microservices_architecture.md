# OneMonitor 微服务架构设计方案

## 1. 架构概述

OneMonitor 将采用**微服务架构**和**前后端分离**的设计模式，将现有单体应用拆分为多个独立的服务，每个服务负责特定的业务领域，通过标准化的通信机制进行交互。该架构将支持高可用、可扩展和容错的企业级运维监控平台。

## 2. 服务拆分策略

按照**功能领域**和**数据模型**进行服务拆分，每个服务拥有独立的代码库、数据库和部署周期：

### 2.1 核心服务模块

| 服务名称 | 功能描述 | 技术栈 | 数据存储 |
|---------|---------|-------|---------|
| **CMDB 服务** | IT 设施配置管理，包括 CI 类型、属性、关系、生命周期管理 | Python + FastAPI | PostgreSQL (属性) + Neo4j (关系) |
| **采集服务** | Metrics、Logs、Traces 遥测数据采集和处理 | Python + OpenTelemetry | Prometheus (时序数据) + Elasticsearch (日志) |
| **告警服务** | 告警规则管理、告警生成、告警聚合和发送 | Python + FastAPI | PostgreSQL + Redis |
| **工单服务** | 工单创建、处理、流转和管理 | Python + FastAPI | PostgreSQL |
| **流程管理服务** | 流程定义、执行和监控 | Python + FastAPI | PostgreSQL |
| **认证服务** | 用户认证、令牌管理和单点登录 | Python + FastAPI + OAuth2 | PostgreSQL |
| **权限服务** | 权限定义、角色管理和访问控制 | Python + FastAPI | PostgreSQL |
| **通知服务** | 邮件、短信、即时消息等通知发送 | Python + FastAPI | Redis (队列) |

### 2.2 应用服务模块

| 服务名称 | 功能描述 | 技术栈 |
|---------|---------|-------|
| **统一工作台服务** | 单点登录、个性化仪表盘、消息中心、待办聚合 | Python + FastAPI |
| **监控展示服务** | 业务视图、系统视图、设备视图、告警视图、基础设施视图 | Vue 3 + ECharts |
| **运维检修服务** | 流程管理、智能巡检、探针工具、自动化运维执行 | Python + FastAPI |

## 3. 服务间通信

### 3.1 同步通信

- **REST API**：使用标准的 HTTP/HTTPS 协议，JSON 格式数据交换
- **gRPC**：对于性能要求高的服务间通信，使用 gRPC 协议

### 3.2 异步通信

- **消息队列**：使用 RabbitMQ 或 Kafka 实现异步消息传递
- **事件驱动**：采用事件驱动架构，服务通过发布/订阅机制进行通信

## 4. 数据存储策略

### 4.1 关系型数据库

- **PostgreSQL**：用于存储结构化数据，如用户信息、工单、流程定义等
- **Schema 隔离**：每个服务拥有独立的数据库 Schema

### 4.2 时序数据库

- **Prometheus**：用于存储监控指标数据

### 4.3 日志数据库

- **Elasticsearch**：用于存储和检索日志数据

### 4.4 图数据库

- **Neo4j**：用于存储和查询配置项之间的关系

### 4.5 缓存

- **Redis**：用于缓存热点数据和实现分布式锁

## 5. 部署架构

### 5.1 Kubernetes 部署

- **命名空间**：使用命名空间隔离不同环境（开发、测试、生产）
- **Ingress**：使用 Ingress 控制器实现服务访问
- **服务发现**：使用 Kubernetes DNS 进行服务发现
- **负载均衡**：使用 Kubernetes Service 实现负载均衡
- **容错**：使用 Pod 副本和自动重启策略实现容错

### 5.2 容器化

- **Docker**：所有服务都将打包为 Docker 镜像
- **Docker Compose**：用于本地开发和测试环境

### 5.3 CI/CD

- **GitLab CI** 或 **Jenkins**：实现持续集成和持续部署
- **Helm Charts**：用于 Kubernetes 应用的打包和部署

## 6. 安全架构

### 6.1 认证与授权

- **OAuth 2.0**：用于用户认证
- **JWT**：用于令牌管理
- **RBAC**：基于角色的访问控制

### 6.2 数据安全

- **HTTPS**：所有通信都将使用 HTTPS
- **数据加密**：敏感数据加密存储
- **数据备份**：定期数据备份和恢复

### 6.3 网络安全

- **网络隔离**：使用 Kubernetes Network Policies 进行网络隔离
- **API Gateway**：使用 API Gateway 实现请求路由、限流和安全防护

## 7. 监控与运维

### 7.1 服务监控

- **Prometheus**：监控服务的性能指标
- **Grafana**：可视化监控数据

### 7.2 日志管理

- **ELK Stack**：收集、存储和分析日志

### 7.3 分布式追踪

- **OpenTelemetry**：实现分布式追踪

## 8. 重构实施计划

### 8.1 第一阶段：基础设施准备

1. 搭建 Kubernetes 集群
2. 配置 CI/CD 流水线
3. 设置监控和日志系统

### 8.2 第二阶段：核心服务拆分

1. 拆分 **CMDB 服务**（已有初步实现）
2. 拆分 **认证服务** 和 **权限服务**
3. 拆分 **采集服务** 和 **告警服务**

### 8.3 第三阶段：应用服务拆分

1. 拆分 **工单服务** 和 **流程管理服务**
2. 拆分 **通知服务**
3. 拆分 **统一工作台服务** 和 **监控展示服务**
4. 拆分 **运维检修服务**

### 8.4 第四阶段：集成测试

1. 服务间集成测试
2. 系统功能测试
3. 性能测试
4. 安全测试

## 9. 预期收益

- **高可用性**：服务独立部署，单个服务故障不影响整个系统
- **可扩展性**：可根据需求独立扩展某个服务
- **灵活性**：每个服务可以使用最适合的技术栈
- **快速迭代**：服务独立开发和部署，缩短开发周期
- **可维护性**：服务代码量减少，易于维护和理解
